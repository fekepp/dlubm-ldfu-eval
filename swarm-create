#!/bin/bash

#t2.micro
#t2.small
#t2.medium
#m4.xlarge


# TODO: Check if UDP ports are opened correctly or use AWS CLI to do it
# Security group ID via: aws ec2 describe-security-groups --filter "Name=group-name,Values=dlubm-swarm" --output text | sed -n 's/.*\(sg-[a-z0-9]*\).*/\1/p'


echo "Swarm > Create swarm manager"
#docker-machine create \
#	--driver amazonec2 \
#	--amazonec2-region eu-central-1 \
#	--amazonec2-security-group dlubm-swarm \
#	--amazonec2-keypair-name fekepp \
#	--amazonec2-ssh-keypath ~/.ssh/id_rsa \
#	--amazonec2-instance-type m4.xlarge \
#	--amazonec2-ami ami-107ba77f \
#	--amazonec2-ssh-user rancher \
#	--amazonec2-open-port 2377 \
#	--amazonec2-open-port 4789 \
#	--amazonec2-open-port 7946 \
#	--amazonec2-open-port 80 \
#	--amazonec2-open-port 8080 \
#	dlubm-swarm-manager
echo "Swarm > Created swarm manager"

manager_ip_internal=$(docker-machine ssh dlubm-swarm-manager "ifconfig eth0 | grep 'inet addr' | cut -d ':' -f 2 | cut -d ' ' -f 1")
echo "Swarm > Manager IP internal > ${manager_ip_internal}"

manager_ip_external=$(docker-machine ip dlubm-swarm-manager)
echo "Swarm > Manager IP external > ${manager_ip_external}"




echo "Swarm > Initializing swarm manager"
#docker-machine ssh dlubm-swarm-manager "docker swarm init \
#	--listen-addr $(docker-machine ssh dlubm-swarm-manager "ifconfig eth0 | grep 'inet addr' | cut -d ':' -f 2 | cut -d ' ' -f 1") \
#	--advertise-addr $(docker-machine ssh dlubm-swarm-manager "ifconfig eth0 | grep 'inet addr' | cut -d ':' -f 2 | cut -d ' ' -f 1")"
echo "Swarm > Initialized swarm manager"

worker_token=$(docker-machine ssh dlubm-swarm-manager "docker swarm join-token worker -q")
echo "Swarm > Worker token > ${worker_token}"



#for worker_index in {001..100}
#for worker_index in {001..018}
for worker_index in {016..018}
#for worker_index in {01..10}
#for worker_index in {01..05}
#for worker_index in {06..10}
do
	
	echo "Swarm > Create swarm worker > ${worker_index}"
	docker-machine create \
		--driver amazonec2 \
		--amazonec2-region eu-central-1 \
		--amazonec2-security-group dlubm-swarm \
		--amazonec2-keypair-name fekepp \
		--amazonec2-ssh-keypath ~/.ssh/id_rsa \
		--amazonec2-instance-type t2.small \
		--amazonec2-ami ami-107ba77f \
		--amazonec2-ssh-user rancher \
		dlubm-swarm-worker-${worker_index}
	echo "Swarm > Created swarm worker > ${worker_index}"
	
	worker_ip_internal=$(docker-machine ssh dlubm-swarm-worker-${worker_index} "ifconfig eth0 | grep 'inet addr' | cut -d ':' -f 2 | cut -d ' ' -f 1")
	echo "Swarm > Worker IP internal > ${worker_ip_internal}"
	
	worker_ip_external=$(docker-machine ip dlubm-swarm-worker-${worker_index})
	echo "Swarm > Worker IP external > ${worker_ip_external}"
	
	
	
	
	echo "Swarm > Join swarm with worker > ${worker_index}"
	docker-machine ssh dlubm-swarm-worker-${worker_index} "docker swarm join \
		--token=$(docker-machine ssh dlubm-swarm-manager "docker swarm join-token worker -q") \
		--listen-addr $(docker-machine ssh dlubm-swarm-worker-${worker_index} "ifconfig eth0 | grep 'inet addr' | cut -d ':' -f 2 | cut -d ' ' -f 1") \
		--advertise-addr $(docker-machine ssh dlubm-swarm-worker-${worker_index} "ifconfig eth0 | grep 'inet addr' | cut -d ':' -f 2 | cut -d ' ' -f 1") \
		$(docker-machine ssh dlubm-swarm-manager "ifconfig eth0 | grep 'inet addr' | cut -d ':' -f 2 | cut -d ' ' -f 1")"
	echo "Swarm > Joined swarm with worker > ${worker_index}"
	
done




echo "Swarm > Retrieve node list from manager"
docker-machine ssh dlubm-swarm-manager "docker node ls"
echo "Swarm > Retrieved node list from manager"

